<html >

	<head >
		<meta http-equiv="Content-Type" content ="text/html;charset=utf-8">
		<meta name="viewport" content ="initial-scale=1,maximum-scale=1,user-scalable=no">
		<title> Test ouverture graphe </title >
		<script src="http://js.arcgis.com/3.14/"></script >
		<link rel="stylesheet" href ="http://js.arcgis.com/3.14/esri/css/esri.css">
		<style>
			#mapDiv{
				padding : 0;
				margin : 0;
				height : 80%;
			}
		</style>
	</head >
	
	<script>
		/*7cbee56db96140998a201bfef29fbabb*/
		
		var map, legend, fLayer, fLayer1, pointSymbol, pointRenderer,label,labelRenderer,labelLayer;
	
		var urlNa = "http://zoe.ensg1.ensg.eu:6080/arcgis/rest/services/projetAndroid/testAndro2/MapServer/NAServer/Itin%C3%A9raire";
		//var urlNa = "http://zoe.ensg1.ensg.eu:6080/arcgis/rest/services/projetAndroid/testAndro2/MapServer/NAServer/0";
		
		require([
			"esri/map",
			"esri/geometry/Extent",
			"esri/graphic",
			"esri/layers/FeatureLayer", 
			"esri/layers/LabelLayer",
			
			"esri/tasks/RouteTask",
			"esri/tasks/RouteParameters",
			"esri/tasks/FeatureSet", 
			"esri/tasks/query",
			"esri/tasks/QueryTask",
			
			"esri/symbols/SimpleMarkerSymbol", 
			"esri/symbols/SimpleLineSymbol",
			"esri/symbols/SimpleFillSymbol",
			"esri/symbols/TextSymbol",
			"esri/renderers/SimpleRenderer",
			"esri/renderers/ClassBreaksRenderer",
			"esri/renderers/ScaleDependentRenderer",
			"esri/Color",
			
			"dojo/dom",
			"dojo/on",
			"dojo/domReady!"
		], function(Map, Extent, Graphic, 
				FeatureLayer, LabelLayer, 
				RouteTask, RouteParameters, FeatureSet, Query, QueryTask, 
				SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol, TextSymbol, SimpleRenderer, ClassBreaksRenderer, ScaleDependentRenderer, Color, 
				dom, on){	
			var bbox, map, cityLayer, labelLayer, limitLayer
			var routeTask, routeParams
			var stopSymbol, routeSymbol, stop, lastStop
			var route

			/**
			* Gestion visualisation :
			**/
			
			//Creation d un fond de carte vierge :
			bbox = new Extent({"xmin": 655400, "ymin": 6780500, "xmax": 738200, "ymax": 6890100, "spatialReference": {"wkid": 102110}});
			map = new Map("mapDiv", {extent: bbox});

			// Ajout graphe
			poncLayer = new esri.layers.FeatureLayer("http://zoe.ensg1.ensg.eu:6080/arcgis/rest/services/projetAndroid/testAndro2/MapServer/11");
			map.addLayer(poncLayer);

			trac0Layer = new esri.layers.FeatureLayer("http://zoe.ensg1.ensg.eu:6080/arcgis/rest/services/projetAndroid/testAndro2/MapServer/12");
			map.addLayer(trac0Layer);

			trac1Layer = new esri.layers.FeatureLayer("http://zoe.ensg1.ensg.eu:6080/arcgis/rest/services/projetAndroid/testAndro2/MapServer/13");
			map.addLayer(trac1Layer);

			trac2Layer = new esri.layers.FeatureLayer("http://zoe.ensg1.ensg.eu:6080/arcgis/rest/services/projetAndroid/testAndro2/MapServer/14");
			map.addLayer(trac2Layer);

			graphLayer = new esri.layers.FeatureLayer("http://zoe.ensg1.ensg.eu:6080/arcgis/rest/services/projetAndroid/testAndro2/MapServer/19");
			map.addLayer(graphLayer);

			/**
			* Gestion rendu :
			**/

			spSymbol = new esri.symbol.SimpleMarkerSymbol(
				SimpleMarkerSymbol.STYLE_DIAMOND, 
				8,
				new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([255,125,255]), 1),
				new Color([0,255,255,0.5])
			);
				
			itSymbol = new SimpleLineSymbol()
			itSymbol.setColor(new dojo.Color([255, 255, 0, 1])).setWidth(7);

			/**
			* Gestion itinÃ©raire
			**/

			// Initialisation routeTask :
			var routeTask = new RouteTask(urlNa);
			routeTask.on("solve-complete", showRoute);

			routeParams = new RouteParameters();
			routeParams.stops = new FeatureSet();
			routeParams.outSpatialReference={wkid:102100};
			
			//Gestion des evenements : 
			on(map,"click",addStop)
			
			// Symboles des arrets
			stopSymbol = new SimpleMarkerSymbol().setStyle(SimpleMarkerSymbol.STYLE_CROSS).setSize(15);
			stopSymbol.outline.setWidth(4);
			routeSymbol = new SimpleLineSymbol().setColor(new dojo.Color([0, 0, 255, 0.5])).setWidth(5);


			/**
			* Definition des fonctions :
			**/
			function addStop(evt){
				center = evt.mapPoint;
				document.getElementById("coords").innerHTML = "LES COORDONNEES DU POINT SONT E:" + center.x + " N : " + center.y;
				stop=map.graphics.add(new Graphic(center,spSymbol));
				routeParams.stops.features.push(stop);
				if (routeParams.stops.features.length >= 2) {
						routeTask.solve(routeParams);
						lastStop = routeParams.stops.features.splice(0, 1)[0];
					}	
			}
			
			function showRoute(evt){
				console.log(evt.result.routeResults);
				map.graphics.add(evt.result.routeResults[0].route.setSymbol(itSymbol));

			}
		});
		
	</script>
	
	<body >
		<div id="coords"></div>
		<div id="mapDiv" ></div >
		<div id="legendDiv" ></div>
	</body >