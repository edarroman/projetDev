<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
		<title>Calcul d'init√©raires</title>
		<link rel="stylesheet" href="http://js.arcgis.com/3.14/dijit/themes/nihilo/nihilo.css">
		<link rel="stylesheet" href="http://js.arcgis.com/3.14/esri/css/esri.css">
		<style>
			html, body {
				height: 100%;
			}
			#mapDiv {
				height: 95%;
				margin: 5px
			}
			#commandesDiv {
				margin: 5px
				background-color: black;
				
			}
		</style>
		
		<script src="http://js.arcgis.com/3.14/"></script>
		<script>			
			require([
				"esri/map",
				"esri/geometry/Extent",
				"esri/graphic",
				"esri/layers/FeatureLayer", 
				"esri/layers/LabelLayer",
				
				"esri/tasks/RouteTask",
				"esri/tasks/RouteParameters",
				"esri/tasks/FeatureSet", 
				"esri/tasks/query",
				"esri/tasks/QueryTask",
				
				"esri/symbols/SimpleMarkerSymbol", 
				"esri/symbols/SimpleLineSymbol",
				"esri/symbols/SimpleFillSymbol",
				"esri/symbols/TextSymbol",
				"esri/renderers/SimpleRenderer",
				"esri/renderers/ClassBreaksRenderer",
				"esri/renderers/ScaleDependentRenderer",
				"esri/Color",
				
				"dojo/dom",
				"dojo/on",
				"dojo/domReady!"
			], function(Map, Extent, Graphic, 
					FeatureLayer, LabelLayer, 
					RouteTask, RouteParameters, FeatureSet, Query, QueryTask, 
					SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol, TextSymbol, SimpleRenderer, ClassBreaksRenderer, ScaleDependentRenderer, Color, 
					dom, on){	
				var bbox, map, cityLayer, labelLayer, limitLayer
				var routeTask, routeParams
				var stopSymbol, routeSymbol, stop, lastStop
				
				
				/* Creation d un fond de carte vierge */
				bbox = new Extent({"xmin": 655400, "ymin": 6780500, "xmax": 738200, "ymax": 6890100, "spatialReference": {"wkid": 102110}});
				map = new Map("mapDiv", {extent: bbox});
				map.on("click", addStop);
				
				
				/* Evenement associe au bouton effacer */
				on(dom.byId("reset"), "click", clearRoute);
				
				
				/* Ajout des limites de communes */
				limitLayer = new esri.layers.FeatureLayer("http://zoe.ensg.eu:6080/arcgis/rest/services/delgrange/Communes_77/MapServer/0");
				var limitSymbol = new SimpleFillSymbol();
				limitSymbol.setOutline(new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([50,50,50]), 1));
				limitSymbol.setColor(new Color([20,20,20,0.02]));
				var limitRenderer = new SimpleRenderer(limitSymbol);
				limitLayer.setRenderer(limitRenderer);
				map.addLayer(limitLayer);
				
				// Symbole de selection
				var departSymbol = new SimpleFillSymbol();
				departSymbol.setOutline(new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([50,50,50]), 1));
				departSymbol.setColor(new Color([20,120,20,0.5]));
				limitLayer.setSelectionSymbol(departSymbol)
				
				
				/* Ajout des lieux dit */
				cityLayer = new esri.layers.FeatureLayer(
					"http://zoe.ensg.eu:6080/arcgis/rest/services/delgrange/Lieu_dit_77/MapServer/0", 
					{outFields: ["NOM", "IMPORTANCE"], definitionExpression: "IMPORTANCE IN ('1', '2', '3', '4')"}
				);
				// Symbologie en 2 niveaux		
				var citySymbolSmall = new SimpleMarkerSymbol();
				citySymbolSmall.setColor(new Color([50,50,250,0.5]));
				citySymbolSmall.setStyle(esri.symbol.SimpleMarkerSymbol.STYLE_SQUARE);
				citySymbolSmall.setSize("4");
				var citySymbolLarge = new SimpleMarkerSymbol();
				citySymbolLarge.setColor(new Color([50,50,250,0.5]));
				citySymbolLarge.setStyle(esri.symbol.SimpleMarkerSymbol.STYLE_SQUARE);
				citySymbolLarge.setSize("10");
				
				var cityRenderer = new ClassBreaksRenderer(null, "IMPORTANCE");
				cityRenderer.addBreak(1, 2, citySymbolLarge);
				cityRenderer.addBreak(2, Infinity, citySymbolSmall);
				cityLayer.setRenderer(cityRenderer);
				map.addLayer(cityLayer);
				
				// Etiquettes variables en fonction du zoom
				var nullLabel = new TextSymbol(" ");
				var cityLabel = new TextSymbol();
				cityLabel.font.setSize("10pt");
				cityLabel.font.setVariant(esri.symbol.Font.VARIANT_SMALLCAPS);
				cityLabel.font.setWeight(esri.symbol.Font.WEIGHT_BOLD);
				cityLabel.font.setStyle(esri.symbol.Font.STYLE_OBLIQUE);
				
				var cityLabelRenderer = new SimpleRenderer(cityLabel);
				var cityScaleDependentRenderer = new ScaleDependentRenderer({
				  rendererInfos: [{
					renderer: cityLabelRenderer,
					minScale: 200000,
					maxScale: 1
				  },{
					renderer: nullLabel,
					minScale: 500000000,
					maxScale: 200000
				  }]
				})
				cityLabelLayer = new LabelLayer();
				cityLabelLayer.addFeatureLayer(cityLayer, cityScaleDependentRenderer, "{NOM}");
				map.addLayer(cityLabelLayer);
				
				
				/* Service d itineraire */
				routeTask = new RouteTask("http://zoe.ensg.eu:6080/arcgis/rest/services/delgrange/Itineraires_77/NAServer/Itin%C3%A9raire");
				routeTask.on("solve-complete", showRoute);
				
				// Parametres du service
				routeParams = new RouteParameters();
				routeParams.stops = new FeatureSet();
				routeParams.outSpatialReference = { wkid:102110 };
				
				// Symboles des arrets
				stopSymbol = new SimpleMarkerSymbol().setStyle(SimpleMarkerSymbol.STYLE_CROSS).setSize(15);
				stopSymbol.outline.setWidth(4);
				routeSymbol = new SimpleLineSymbol().setColor(new dojo.Color([0, 0, 255, 0.5])).setWidth(5);

				
				/* Ajout d un point lors d un clic sur la carte */
				function addStop(evt) {
					var center = evt.mapPoint;
					// Dessin du point et ajout a itineraire
					stop = map.graphics.add(new Graphic(center, stopSymbol));
					routeParams.stops.features.push(stop);
					
					// Selection de la commune sous le point
					var query = new Query();
					query.returnGeometry = true;
					query.geometry = center;
					query.spatialRelationship = esri.tasks.Query.SPATIAL_REL_WITHIN;
					limitLayer.selectFeatures(query, FeatureLayer.SELECTION_ADD);
					
					// Si plus de 2 points, calcul de l itineraire
					if (routeParams.stops.features.length >= 2) {
						routeTask.solve(routeParams);
						lastStop = routeParams.stops.features.splice(0, 1)[0];
					}
				}

				
				/* Dessin de la route dans la carte */
				function showRoute(evt) {
					map.graphics.add(evt.result.routeResults[0].route.setSymbol(routeSymbol));
				}
				
				
				/* Re initialisation de l itineraire */
				function clearRoute() {
					map.graphics.clear();
					routeParams.stops = new FeatureSet();
					limitLayer.clearSelection();
				}
			});
		</script>
	</head>
	<body class="claro">
		<div id="mapDiv"></div>
		<div id="commandesDiv">
			<input id="reset" type="button" value="Effacer">
		</div>
	</body>
</html>

